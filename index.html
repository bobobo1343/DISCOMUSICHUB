<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DISCOMUSICHUB — Ultimate Drive Player (All songs loader)</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#151515; --muted:#bdbdbd; --accent:#1db954;
    --accent-2:#1ed760; --card:#212121;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:#eee}
  header{background:linear-gradient(90deg,var(--accent),#0bb87a);padding:14px 20px;font-weight:700;font-size:20px}
  .topbar{display:flex;gap:12px;align-items:center;padding:10px 18px;background:var(--panel);border-bottom:1px solid #222}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  button, .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#08120b}
  #main{display:grid;grid-template-columns:320px 1fr 360px;gap:14px;height:calc(100% - 110px);padding:18px}
  #left{background:var(--panel);padding:12px;border-radius:12px;overflow:auto}
  #folder-tree{list-style:none;padding:6px;margin:0}
  #folder-tree li{padding:8px;border-radius:8px;margin:6px 0;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  #folder-tree li.folder{background:linear-gradient(180deg,transparent,rgba(255,255,255,0.02))}
  #center{background:linear-gradient(180deg,#0e0e0f,#0c0c0d);padding:12px;border-radius:12px;overflow:auto}
  #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
  .card{background:var(--card);padding:12px;border-radius:12px;transition:transform .12s,box-shadow .12s;cursor:pointer;display:flex;flex-direction:column;gap:8px}
  .card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(0,0,0,0.4)}
  .thumb{height:140px;border-radius:8px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .meta .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta .sub{color:var(--muted);font-size:13px}
  #right{background:var(--panel);padding:12px;border-radius:12px;overflow:auto;display:flex;flex-direction:column}
  #queue{flex:1;overflow:auto;margin-bottom:12px}
  .queue-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#111;margin:6px 0}
  #playerbar{display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;background:linear-gradient(90deg,#0b0b0b,#0e0e0f)}
  #playerbar img{width:72px;height:72px;border-radius:8px;object-fit:cover}
  .player-info{flex:1;overflow:hidden}
  .player-info .t{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .player-controls{display:flex;align-items:center;gap:8px}
  #progressWrap{height:8px;background:#131313;border-radius:8px;flex:1;cursor:pointer;position:relative}
  #progressBar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0;border-radius:8px}
  .small{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}
  .search{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input[type=search]{flex:1;padding:8px;background:#0b0b0b;border-radius:8px;border:1px solid #222;color:#eee}
  .status{font-size:13px;color:var(--muted);margin-left:8px}
  .loader{height:8px;background:#222;border-radius:8px;overflow:hidden}
  .loader div{height:100%;background:linear-gradient(90deg,rgba(29,185,84,.2),rgba(29,185,84,.8));width:0;transition:width .15s linear}
  @media(max-width:1100px){#main{grid-template-columns:1fr;grid-auto-rows:auto;height:calc(100% - 160px)}#right{order:3}}
</style>
</head>
<body>

<header>DISCOMUSICHUB — Ultimate Drive Player</header>

<div class="topbar">
  <div style="font-weight:700">Drive streaming: PLAYBOICARTI · KEN CARSON · DESTROY LONELY</div>
  <div class="controls">
    <button id="btnLoadAll" class="btn primary">Load ALL songs</button>
    <button id="btnRefresh" class="btn">Refresh current</button>
    <div style="width:220px" class="search">
      <input id="search" type="search" placeholder="Search songs / folders..." />
    </div>
    <div class="status" id="scanStatus"></div>
  </div>
</div>

<div id="main">
  <div id="left">
    <div class="small muted">Folders</div>
    <div class="search" style="margin-top:8px">
      <input id="leftSearch" type="search" placeholder="Filter folders..." />
    </div>
    <ul id="folder-tree"></ul>
    <div style="margin-top:12px" class="small muted">Scan progress</div>
    <div class="loader" style="margin-top:8px"><div id="progressScan"></div></div>
  </div>

  <div id="center">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">Browse / Songs</div>
      <div class="small muted" id="resultCount">0 songs</div>
    </div>

    <div id="grid"></div>
  </div>

  <div id="right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Queue</div>
      <div class="small muted">Drag to reorder</div>
    </div>
    <div id="queue" style="margin-top:8px"></div>

    <div id="playerbar" style="margin-top:12px">
      <img id="barArt" src="https://via.placeholder.com/96?text=No+Art" alt="art" />
      <div class="player-info">
        <div class="t" id="barTitle">Not playing</div>
        <div class="small muted" id="barArtist"></div>
        <div class="small muted" id="timeText">0:00 / 0:00</div>
      </div>
      <div class="player-controls">
        <button id="prev">⏮️</button>
        <button id="playPause">▶️</button>
        <button id="next">⏭️</button>
      </div>
      <div id="progressWrap"><div id="progressBar"></div></div>
    </div>
  </div>
</div>

<script>
/* =========== CONFIG =========== */
const API_KEY = 'AIzaSyCoNrL7Omej-ct3IlB02OjTMhvtVFmy0b0';
const ARTISTS = {
  'PLAYBOICARTI': '1tgOfvE-l9iBiXtzii8Xkx44U6mOwaItK',
  'KEN CARSON': '1B3jfYcb7ikY-YiqUWNIFqU9GJd22MeVN',
  'DESTROY LONELY': '1I0-pM0AbW2mSybBc6HVFuYMyFDQ2nasm'
};
const METADATA_BASE = 'https://raw.githubusercontent.com/bobobo1343/DISCOMUSICHUB/main/'; // JSONs live here
const METADATA_FILES = ['playboicarti.json','ken_carson.json','destroy_lonely.json'];
/* ============================== */

/* UI refs */
const folderTree = document.getElementById('folder-tree');
const grid = document.getElementById('grid');
const queueEl = document.getElementById('queue');
const scanStatus = document.getElementById('scanStatus');
const progressScan = document.getElementById('progressScan');
const resultCount = document.getElementById('resultCount');
const search = document.getElementById('search');
const leftSearch = document.getElementById('leftSearch');

const barArt = document.getElementById('barArt');
const barTitle = document.getElementById('barTitle');
const barArtist = document.getElementById('barArtist');
const timeText = document.getElementById('timeText');
const playPauseBtn = document.getElementById('playPause');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const progressWrap = document.getElementById('progressWrap');
const progressBar = document.getElementById('progressBar');
const btnLoadAll = document.getElementById('btnLoadAll');
const btnRefresh = document.getElementById('btnRefresh');

let metadataMap = {}; // filename -> metadata item
let audio = new Audio();
let allSongs = []; // flattened list of all found audio files {file, path:[folder names]}
let displayedSongs = []; // filtered by search
let queue = [];
let playingIndex = -1; // index into queue
let isPlaying = false;

/* helpers */
const audioExts = ['mp3','m4a','wav','ogg','flac','aac','mka','mp4','webm'];

function isAudio(file){
  if(!file) return false;
  if(file.mimeType && file.mimeType.startsWith('audio/')) return true;
  const ext = (file.name||'').split('.').pop().toLowerCase();
  return audioExts.includes(ext);
}
function qEncode(s){ return encodeURIComponent(s).replace(/'/g,'%27'); }

/* Google Drive helpers: list files in a folder (handles pageToken) */
async function listFilesInFolder(folderId, pageToken=null){
  let url = `https://www.googleapis.com/drive/v3/files?q='${qEncode(folderId)}'+in+parents+and+trashed=false&key=${API_KEY}&fields=nextPageToken,files(id,name,mimeType,thumbnailLink,shortcutDetails)`;
  if(pageToken) url += `&pageToken=${pageToken}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Drive list error ${res.status}`);
  return res.json();
}

/* fetch single file metadata by id (used to resolve shortcuts) */
async function getFileById(id){
  const url = `https://www.googleapis.com/drive/v3/files/${qEncode(id)}?key=${API_KEY}&fields=id,name,mimeType,thumbnailLink`;
  const res = await fetch(url);
  if(!res.ok) { console.warn('getFileById failed',id,res.status); return null; }
  return res.json();
}

/* recursively walk folder and collect audio files
   pathNames: array of folder names from root to this folder (for metadata / breadcrumb) */
async function walkFolderCollect(folderId, pathNames, onProgress){
  let pageToken = null;
  let folderFiles = [];
  do {
    const data = await listFilesInFolder(folderId, pageToken);
    pageToken = data.nextPageToken;
    for(const f of data.files){
      // If folder -> recurse
      if(f.mimeType === 'application/vnd.google-apps.folder'){
        // recursively gather songs inside subfolder
        const sub = await walkFolderCollect(f.id, [...pathNames, f.name], onProgress);
        folderFiles = folderFiles.concat(sub);
      } else if(f.mimeType === 'application/vnd.google-apps.shortcut' && f.shortcutDetails && f.shortcutDetails.targetId){
        // Resolve shortcut target
        const target = await getFileById(f.shortcutDetails.targetId);
        if(target){
          if(target.mimeType === 'application/vnd.google-apps.folder'){
            const sub = await walkFolderCollect(target.id, [...pathNames, f.name], onProgress);
            folderFiles = folderFiles.concat(sub);
          } else if(isAudio(target)){
            folderFiles.push({ file: target, path: [...pathNames, f.name] });
            onProgress && onProgress();
          }
        }
      } else if(isAudio(f)){
        folderFiles.push({ file: f, path: pathNames });
        onProgress && onProgress();
      } else {
        // check by extension (some files may not have correct mime)
        const ext = (f.name||'').split('.').pop().toLowerCase();
        if(audioExts.includes(ext)){
          folderFiles.push({ file: f, path: pathNames });
          onProgress && onProgress();
        }
      }
    }
  } while(pageToken);
  return folderFiles;
}

/* load metadata JSONs from your GitHub repo and merge */
async function loadMetadata(){
  metadataMap = {};
  for(const jf of METADATA_FILES){
    try{
      const url = METADATA_BASE + jf;
      const r = await fetch(url);
      if(!r.ok) { console.warn('metadata missing',jf); continue; }
      const arr = await r.json();
      for(const it of arr){
        // Accept title OR filename fields; strip path parts so match by filename if JSON uses paths
        const key = (it.title || it.filename || (it.url && it.url.split('/').pop()) || '').trim();
        if(key) metadataMap[key] = it;
      }
    }catch(e){ console.warn('metadata load error',jf,e) }
  }
}

/* UI renderers */
function renderFolderTree(artists){
  folderTree.innerHTML = '';
  for(const a of artists){
    const li = document.createElement('li');
    li.className = 'folder';
    li.textContent = a.name;
    li.onclick = ()=> { queryAndShowFolder(a.id); };
    folderTree.appendChild(li);
  }
}

function renderGrid(songs){
  grid.innerHTML = '';
  displayedSongs = songs;
  resultCount.textContent = `${songs.length} songs`;
  for(const s of songs){
    const meta = metadataMap[s.file.name] || {};
    const title = meta.title || s.file.name;
    const artist = meta.artist || s.path[0] || '';
    const art = meta.artwork || (meta.artwork && meta.artwork.startsWith('http') ? meta.artwork : null) || s.file.thumbnailLink || 'https://via.placeholder.com/480x480?text=No+Art';
    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = ()=> { enqueueAndPlay(s); };
    card.innerHTML = `
      <div class="thumb"><img src="${art}" alt="art" loading="lazy" onerror="this.src='https://via.placeholder.com/480x480?text=No+Art'"/></div>
      <div class="meta">
        <div style="flex:1">
          <div class="title">${escapeHtml(title)}</div>
          <div class="sub">${escapeHtml(artist)}</div>
        </div>
        <div class="sub muted">${formatExtSize(s.file.name)}</div>
      </div>
    `;
    grid.appendChild(card);
  }
}

function renderQueue(){
  queueEl.innerHTML = '';
  for(let i=0;i<queue.length;i++){
    const item = queue[i];
    const div = document.createElement('div');
    div.className = 'queue-item';
    if(i===playingIndex) div.style.background = 'linear-gradient(90deg,var(--accent),var(--accent-2))';
    div.innerHTML = `<div style="flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${escapeHtml(item.file.name)}</div><div style="margin-left:8px"><button style="background:none;border:none;color:#ff6b6b;cursor:pointer">✖</button></div>`;
    // remove button
    div.querySelector('button').onclick = (e)=>{ e.stopPropagation(); queue.splice(i,1); if(i<=playingIndex) playingIndex--; renderQueue(); }
    div.onclick = ()=>{ playQueueAt(i); }
    queueEl.appendChild(div);
  }
}

/* small helpers */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatExtSize(name){ const ext = (name||'').split('.').pop().toUpperCase(); return ext; }

/* enqueue and play */
function enqueueAndPlay(songObj){
  // Add if not present
  const found = queue.findIndex(q=>q.file.id===songObj.file.id);
  if(found === -1){
    queue.push(songObj);
    playingIndex = queue.length -1;
  } else {
    playingIndex = found;
  }
  renderQueue();
  playQueueAt(playingIndex);
}

/* play queue index */
function playQueueAt(i){
  if(i<0 || i>=queue.length) return;
  playingIndex = i;
  const item = queue[i];
  const url = `https://www.googleapis.com/drive/v3/files/${qEncode(item.file.id)}?alt=media&key=${API_KEY}`;
  audio.src = url;
  audio.play().catch(err=>console.warn('play error',err));
  isPlaying = true;
  updatePlayerBar(item);
  renderQueue();
}

/* update player bar UI */
function updatePlayerBar(item){
  const meta = metadataMap[item.file.name] || {};
  barArt.src = meta.artwork || item.file.thumbnailLink || 'https://via.placeholder.com/96?text=No+Art';
  barTitle.textContent = meta.title || item.file.name;
  barArtist.textContent = meta.artist || (item.path && item.path[0]) || '';
}

/* play/pause toggle */
playPauseBtn.onclick = ()=> {
  if(!audio.src) return;
  if(audio.paused){ audio.play(); isPlaying=true; playPauseBtn.textContent='⏸️'; }
  else { audio.pause(); isPlaying=false; playPauseBtn.textContent='▶️'; }
}

/* prev/next */
prevBtn.onclick = ()=> {
  if(queue.length===0) return;
  playingIndex = (playingIndex-1+queue.length) % queue.length;
  playQueueAt(playingIndex);
}
nextBtn.onclick = ()=> {
  if(queue.length===0) return;
  if(shuffleMode) playingIndex = Math.floor(Math.random()*queue.length);
  else playingIndex = (playingIndex+1) % queue.length;
  playQueueAt(playingIndex);
}

/* progress & time */
audio.ontimeupdate = ()=> {
  if(audio.duration){ const pct = (audio.currentTime/audio.duration)*100; progressBar.style.width = pct+'%'; timeText.textContent = formatTime(audio.currentTime)+' / '+formatTime(audio.duration); }
}
progressWrap.onclick = (e)=> {
  if(!audio.duration) return;
  const rect = progressWrap.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pct * audio.duration;
}

/* volume and mute */
volumeSlider.oninput = ()=> { audio.volume = volumeSlider.value; }
document.getElementById('mute-toggle').onclick = ()=> {
  if(audio.volume>0){ audio.volume=0; volumeSlider.value=0; } else { audio.volume=1; volumeSlider.value=1; }
}

/* repeat & shuffle state */
let repeatMode = 0; // 0 off,1 one,2 all
let shuffleMode = false;
document.getElementById('repeat').onclick = ()=>{ repeatMode=(repeatMode+1)%3; }
document.getElementById('shuffle').onclick = ()=>{ shuffleMode=!shuffleMode; }

/* keyboard shortcuts */
document.addEventListener('keydown', e=>{
  if(e.target.tagName==='INPUT') return;
  if(e.code==='Space'){ e.preventDefault(); playPauseBtn.click(); }
  if(e.code==='ArrowRight') nextBtn.click();
  if(e.code==='ArrowLeft') prevBtn.click();
});

/* format time */
function formatTime(s){ if(!s || isNaN(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60); return m+':'+String(sec).padStart(2,'0'); }

/* ========== MAIN: load metadata, then allow "Load All Songs" ========== */

async function scanAllArtists(onProgress){
  allSongs = [];
  let done = 0;
  const artistEntries = Object.entries(ARTISTS);
  const totalArtists = artistEntries.length;
  scanStatus.textContent = 'scanning...';
  for(const [name, folderId] of artistEntries){
    // fetch recursively
    const list = await walkFolderCollect(folderId, [name], ()=> {
      done++;
      const pct = Math.min(100, Math.round((done/30)*100)); // rough
      progressScan.style.width = Math.min(100, pct) + '%';
      onProgress && onProgress(done);
    });
    allSongs = allSongs.concat(list);
  }
  // dedupe by file.id
  const unique = {};
  allSongs.forEach(s=> unique[s.file.id] = s);
  allSongs = Object.values(unique);
  scanStatus.textContent = `scan complete — ${allSongs.length} songs found`;
  progressScan.style.width = '100%';
  return allSongs;
}

/* Load metadata + bind UI */
async function init(){
  // load metadata JSONs
  await loadMetadata();
  // render artists list in side tree
  const artists = Object.entries(ARTISTS).map(([name,id])=>({name,id}));
  renderFolderTree(artists);
  // wire search to filter grid
  search.addEventListener('input', ()=> {
    const q = search.value.trim().toLowerCase();
    const filtered = allSongs.filter(s => (s.file.name + ' ' + (s.path||[]).join(' ')).toLowerCase().includes(q));
    renderGrid(filtered);
  });
  leftSearch.addEventListener('input', ()=> {
    const q=leftSearch.value.trim().toLowerCase();
    [...folderTree.querySelectorAll('li')].forEach(li => {
      li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  // load-all button
  btnLoadAll.onclick = async ()=>{
    btnLoadAll.disabled = true; btnLoadAll.textContent='Scanning...';
    progressScan.style.width = '6%';
    try{
      const list = await scanAllArtists();
      // present results in center grid
      allSongs = list;
      renderGrid(allSongs);
      renderQueue();
    }catch(err){
      console.error(err);
      alert('Scan error: '+err.message);
    } finally {
      btnLoadAll.disabled = false; btnLoadAll.textContent='Load ALL songs';
    }
  };
  btnRefresh.onclick = ()=> { if(allSongs.length) renderGrid(allSongs); }
}

/* play queue index helper */
function playQueueAtIndex(idx){ playQueueAt(idx); }

/* Run init */
init();

</script>
</body>
</html>
